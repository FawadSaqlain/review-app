<div class="card">
<h1><i class="fa-solid fa-star-half-stroke" style="margin-right:8px;color:var(--primary);"></i>My Ratings</h1>
<script>window.CURRENT_USER_ID = "<%= typeof currentUserId !== 'undefined' && currentUserId ? currentUserId : '' %>";</script>
<div class="filters" style="margin-top:8px;">
  <label>Search<br/><input id="search" type="text" placeholder="comment or course/teacher" /></label>
  <button id="apply">Apply</button>
</div>
<div id="results">
  <table id="ratingsTable" class="table">
    <thead><tr><th>Offering (Teacher — Course)</th><th>Overall</th><th>Marks</th><th>Comment</th><th>Submitted</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
<script>
async function fetchRatings(q={}){
  const params = new URLSearchParams(q);
  const res = await fetch('/api/ratings?' + params.toString());
  const json = await res.json();
  return json;
}

function renderRow(r){
  const tr = document.createElement('tr');
  let offeringLabel = 'N/A';
  try {
    if (r.offering) {
      const t = r.offering.teacher;
      const c = r.offering.course;
      const teacherName = t ? ((t.name && t.name.first) ? (t.name.first + (t.name.last ? ' ' + t.name.last : '')) : (t.email || 'TBD')) : 'TBD';
      const courseLabel = c ? ((c.code ? c.code + ' - ' : '') + (c.title || '')) : '';
      offeringLabel = `${teacherName}${courseLabel ? ' — ' + courseLabel : ''}`;
    }
  } catch(e) { offeringLabel = 'N/A'; }
  tr.innerHTML = `<td>${offeringLabel}</td><td>${r.overallRating}</td><td>${r.obtainedMarks}</td><td>${r.comment||''}</td><td>${new Date(r.createdAt).toLocaleString()}</td><td><button data-id="${r._id}" class="edit">Edit</button></td>`;
  return tr;
}

document.getElementById('apply').addEventListener('click', async ()=>{
  const q = {};
  const search = document.getElementById('search').value;
  if (search) q.search = search;
  // limit to current user via student param if available in page global 'CURRENT_USER_ID'
  if (window.CURRENT_USER_ID) q.student = window.CURRENT_USER_ID;
  // only show ratings for offerings in the active term
  q.termActive = true;
  const json = await fetchRatings(q);
  const tbody = document.querySelector('#ratingsTable tbody'); tbody.innerHTML='';
  if (json && json.success){
    json.data.items.forEach(r=> tbody.appendChild(renderRow(r)));
    tbody.querySelectorAll('.edit').forEach(btn=> btn.addEventListener('click', (e)=>{
      const id = e.target.dataset.id;
      if (!id) return;
      window.location.href = '/ratings/' + id + '/edit';
    }));
  }
});

// auto-load
document.getElementById('apply').click();
</script>